<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>iSMSDeliver</title>
    <link rel="stylesheet" href="jquery.mobile-1.0.1.css"/>
    <style>
            /* App custom styles */
    </style>
    <script type="text/javascript" src="phonegap.js"></script>
    <script type="text/javascript" src="cordova-1.5.0.js"></script>
    <script src="jquery.min.js"></script>
    <script src="jquery.mobile-1.0.1.js"></script>
    <script src="jquery-ui-1.8.18.custom.min.js"></script>
    <script src="jquery.mobile.structure-1.0.1.css"></script>
</head>
<body>
<div data-role="page" id="pageLogin">
    <div data-role="content">
        <div data-role="fieldcontain">
            <fieldset data-role="controlgroup">
                <label for="userNameField">
                    UserName:
                </label>
                <input id="userNameField" placeholder="your magtifun username" value="" type="text"/>
            </fieldset>
        </div>
        <div data-role="fieldcontain">
            <fieldset data-role="controlgroup">
                <label for="passwordField">
                    Password:
                </label>
                <input id="passwordField" placeholder="your magtifun password" value="" type="password"/>
            </fieldset>
        </div>
        <input type="submit" id="login" data-theme="b" value="Login"/>
    </div>
</div>
<div data-role="page" id="pageMain">
    <div data-role="content">
        <div data-role="fieldcontain">
            <fieldset data-role="controlgroup">
                <label for="recipients">
                    Recipients:
                </label>
                <input id="recipients" value="" placeholder="recipient number or contact name" type="text"/>
            </fieldset>
        </div>
        <div data-role="fieldcontain">
            <fieldset data-role="controlgroup">
                <label for="msgBody">
                    Message Body:
                </label>
                <textarea id="msgBody"></textarea>
            </fieldset>
        </div>
        <input type="submit" id="send" data-theme="b" value="send"/>
        <input type="submit" id="back" data-theme="b" value="back"/>
    </div>
</div>
<script>
    var cookie;
    var suggestions = [];
    $.ajaxSetup({
        cache:false,
        crossDomain:true
    });
    $('#login').click(function (e) {
        e.preventDefault();
        var user = $("#userNameField").val();
        var password = $("#passwordField").val();
        $.mobile.loadingMessage = "Logining...";
        $.mobile.showPageLoadingMsg();
        var jqxhr = $.ajax({
            type:"POST",
            url:'http://www.magtifun.ge/index.php?page=11&lang=ge',
            data:{act:1, user:user, password:password},
            beforeSend:function (xhr) {
                xhr.setRequestHeader('Cookie', '');
            },
            success:function (data) {
                cookie = jqxhr.getResponseHeader('Set-Cookie').split(';')[0];
                checkLogged(cookie);
            }
        });
    });
    $('#back').click(function (e) {
        e.preventDefault();
        $.mobile.changePage($("#pageLogin"), { transition:"flip"});
    });
    $('#send').click(function (e) {
        e.preventDefault();
        var recipients = $('#recipients').val();
        var msgBody = $('#msgBody').val();
        $.mobile.loadingMessage = "Sending...";
        $.mobile.showPageLoadingMsg();
        $.ajax({
            type:"POST",
            url:'http://www.magtifun.ge/scripts/sms_send.php',
            data:{recipients:recipients, message_body:msgBody},
            cache:false,
            beforeSend:function (xhr) {
                xhr.setRequestHeader('Cookie', cookie);
            },
            success:function (data) {
                if (data == 'not_logged_in') {
                    navigator.notification.alert("Not Logged in!!\nHow you Got hire?", null, "MissBehaive", "I'm Sorry!");
                    $.mobile.changePage($("#pageLogin"), { transition:"flip"});
                }
                $.mobile.hidePageLoadingMsg();
                $('#recipients').val("");
                $('#msgBody').val("");
            }
        });
    });
    function checkLogged(cookie) {
        $.ajax({
            type:"POST",
            url:'http://www.magtifun.ge/scripts/profile_check.php',
            data:{},
            beforeSend:function (xhr) {
                xhr.setRequestHeader('Cookie', cookie);
            },
            success:function (data) {
                if (data == 'not_logged_in') {
                    navigator.notification.alert("Wrong Username or Password", null, "MissBehaive", "I'm Sorry!");
                    navigator.notification.vibrate("890");
                } else {
                    $.mobile.hidePageLoadingMsg();
                    $.mobile.changePage($("#pageMain"), { transition:"flip"});
                }
            }
        });
    }
    function onSuccess(contacts) {
        for (var i = 0; i < contacts.length; i++) {
            for (var j = 0; j < contacts[i].phoneNumbers.length; j++) {
                console.log(contacts[i].name.formatted + "(" + contacts[i].phoneNumbers[j].value + ")");
                suggestions.push(contacts[i].name.formatted + "(" + contacts[i].phoneNumbers[j].value + ")");
            }
        }
    }

    function onError(contactError) {
        alert('onError!');
    }

    function autocomplateContacts(req, add) {
        var options = new ContactFindOptions();
        options.filter = req.term;
        options.multiple = true;
        filter = ["displayName", "name", "phoneNumbers"];
        navigator.contacts.find(filter, onSuccess, onError, options);
    }

    function contactSelected(e, ui) {
        console.log("\n");
        console.log(e);
        console.log("\n");
        console.log(ui);
        console.log("\n");
    }

    $("#recipients").autocomplete({ source:autocomplateContacts, select:contactSelected  });
</script>
</body>
</html>